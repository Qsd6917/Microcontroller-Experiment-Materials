//【附录二】由C语言编制的I2C通讯子函数
#include "reg51.h"
#include "intrins.h"
#define  DELAY5US _nop_();
sbit 	SDA=P1^0;
sbit 	SCL=P1^1;
// 以上的内容如果在主函数的前面已经包含、声明时，可以省略。
//#################################################################################
void STA(void) 						//启动信号子函数
{	 SDA=1;
     SCL=1;
     DELAY5US 	 
	 SDA=0;
	 DELAY5US 
     SCL=0;
}
//#################################################################################
void STOP(void) 					//停止信号子函数
{   SDA=0;
    SCL=1; 	
	DELAY5US 
	SDA=1;
	DELAY5US  	
}
//#################################################################################
void MACK(void) 					//应答信号子函数
{    SDA=0;
     SCL=1;
	 DELAY5US 	
	 SCL=0;
	 SDA=1;
}
//#################################################################################
void NMACK(void) 					//非应答信号子函数

{    SDA=1;
     SCL=1;
	 DELAY5US   	 
	 SCL=0;
	 SDA=0;
}
//#################################################################################
void CACK(void)         			//应答检测子程序
{   
     SDA=1;
     SCL=1;
	 DELAY5US    	 
	 F0=0;
	 if(SDA==1)
	 F0=1;
	 SCL=0;
}
//#################################################################################
//                             发送一字节子数据程序     WRBYT
//#################################################################################
void WRBYT(unsigned char  *p)
{    unsigned char  i=8,temp;
     temp=*p;
	 while(i--)
	 {   if((temp&0x80)==0x80)
	         {  SDA=1; 
			    SCL=1; 			
				DELAY5US 				
				SCL=0; 			 
			 }
			 else
			 {  SDA=0;
			    SCL=1; 				
				DELAY5US 				
				SCL=0;
			 }
			 temp=temp<<1;
	 }
}
//#################################################################################
//                            接收一字节子数据程序     RDBYT
//#################################################################################
void RDBYT(unsigned char  *p)
{    unsigned char i=8,temp=0;
     while(i--)
	 {    SDA=1;
	      SCL=1;
		  DELAY5US   		  
		  temp=temp<<1;
		  if(SDA==1)
		  	temp=temp|0x01;
		  else
		    temp=temp&0xfe;
          SCL=0;
	 }
     *p=temp;
}
//#################################################################################
//                           发送N个字节子数据程序     WRNBYT
//#################################################################################
void WRNBYT(unsigned char  *R3,unsigned char  *R2,unsigned char  *R0,unsigned char  n)
{                
 loop:    STA();
	      WRBYT(R3);
	      CACK();
	      if(F0)
	      goto loop;
		  WRBYT(R2);
		  CACK();
		  if(F0)
		  goto loop;
		  while(n--)
		  {  WRBYT(R0);
		     CACK();
			 if(F0)
			  goto loop;
			  R0++;
		  } 
          STOP();
}
//#################################################################################
//                            接收N个字节子数据程序     RDNBYT
//#################################################################################
//【子函数入口参数说明】：
//R3是外部器件地址写，R4是外部器件地址读，R2是从器件内部子地址，R0是目标数据块首地址，//n是要读的字节数
void RDNBYT(unsigned char  *R3,unsigned char  *R4,unsigned char  *R2,unsigned char  *R0,unsigned char  n)
{   
     loop1:  STA();
			 WRBYT(R3);
			 CACK();
			 if(F0)
			 goto loop1;
			 WRBYT(R2);
			 CACK();
			 if(F0)
			 goto loop1;
			 STA();
			 WRBYT(R4);
			 CACK();
			 if(F0)
			 goto loop1;
			 while(n--)
			 {    RDBYT(R0);
			    if(n>0)
  				    {
					  MACK();
				      R0++;
			        }
				 else  NMACK();
				 } 			  
			 STOP();
}
//#################################################################################
